<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Donor Board – Admin</title>
<link rel="icon" href="assets/favicon.svg">
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="leftcol">
      <h1 style="margin:0 0 12px;">Donor Board – Admin</h1>

      <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button id="openDisplay" type="button">Open Display Page</button>
        <button id="clearAll" type="button" title="Remove all donors (affects display)">Clear All</button>
        <span style="color:#666; font-size:13px;">Paste names (newline, comma, or tab‑separated). Add '+' anywhere in a name to auto‑emphasize it. Duplicates are ignored.</span>
      </div>

      <p></p>
      <textarea id="nameInput" style="width:min(900px,100%); height:160px; padding:12px; font-size:16px;" placeholder="e.g.
Jane Smith	John D. Brown+, Alicia +Cruz
The +Morales Family"></textarea>
      <p class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <button class="primary" id="addNames" type="button">Add Names</button>
      </p>

      <!-- CSV IMPORT -->
      <div class="import-wrap">
        <label class="dropzone" id="dropzone">
          <input type="file" id="csvInput" accept=".csv,text/csv" multiple />
          <div>
            <strong>Drop CSVs here</strong><br/>
            <span class="hint">Required: <em>OneCause&nbsp;‑&nbsp;Donations</em>. Optional: <em>paid‑donations</em> (filters anonymous donors).</span><br/>
            <button type="button" id="browseBtn" style="margin-top:8px;">Browse…</button>
          </div>
        </label>
        <div class="controls">
          <div class="field"><label for="threshold"><strong>Emphasize threshold ($)</strong></label> <input type="number" id="threshold" min="0" step="50" value="1000"></div>
          <div class="field"><span>Columns used:</span> <code>B (amount)</code> & <code>M (name)</code></div>
          <div class="field"><label for="filterSource"><strong>paid-donations source</strong></label>
            <input type="text" id="filterSource" placeholder="e.g. Gala 2025"></div>
        </div>
        <div class="csv-status">
          <div>Primary (<em>OneCause - Donations</em>): <span id="primaryStatus" class="csv-pill">Not loaded</span></div>
          <div>Filter (<em>paid-donations</em>): <span id="filterStatus" class="csv-pill">Not loaded</span></div>
        </div>
        <div class="field" style="margin-top:8px;">
          <label for="totalDisplay"><strong>Total raised label</strong></label>
          <input type="text" id="totalDisplay" placeholder="e.g. $2.5M Raised" style="flex:1; min-width:220px;">
        </div>
      </div>

      <div class="admin-chips" style="margin-top:16px;">
        <h3>Current donors (<span id="count">0</span>)</h3>
        <div id="chips"></div>
      </div>
    </div>

    <!-- RIGHT COLUMN: THEME PANEL -->
    <aside class="rightcol">
      <div class="theme-panel" id="themePanel">
        <h3>Display Theme</h3>
        <div class="theme-grid">
          <div class="theme-row"><label>Background</label><input type="color" id="bgColor"></div>
          <div class="theme-row"><label>Title color</label><input type="color" id="titleColor"></div>
          <div class="theme-row"><label>Name color</label><input type="color" id="nameColor"></div>
          <div class="theme-row"><label>Emphasized color</label><input type="color" id="emphColor"></div>
          <div class="theme-row"><label>Name weight</label>
            <select id="nameWeight">
              <option>200</option><option>300</option><option selected>400</option><option>500</option><option>600</option><option>700</option><option>800</option>
            </select>
          </div>
          <div class="theme-row"><label>Emph. weight</label>
            <select id="emphWeight">
              <option>400</option><option>500</option><option>600</option><option selected>700</option><option>800</option><option>900</option>
            </select>
          </div>
          <div class="theme-row"><label>Total color</label><input type="color" id="totalColor"></div>
          <div class="theme-row"><label>Total weight</label>
            <select id="totalWeight">
              <option>300</option><option selected>500</option><option>600</option><option>700</option><option>800</option>
            </select>
          </div>
          <div class="theme-row"><label>Emph. scale</label><input type="range" id="emphScale" min="1.0" max="1.8" step="0.05" value="1.35"></div>
          <div class="theme-row"><label>Background image</label><input type="file" id="bgImage" accept="image/*"></div>
        </div>
        <div class="theme-actions">
          <button id="resetTheme" type="button">Reset</button>
          <button id="pushTheme" type="button" class="primary">Apply & Push</button>
        </div>
      </div>
    </aside>
  </div>
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title"></h2>
        <button type="button" class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-actions"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = 'donorList.v1';
  const EMPH_KEY = 'donorEmphasized.v1';
  const THEME_KEY = 'donorTheme.v1';
  const TOTAL_KEY = 'donorTotal.v1';
  const MSG_KEY = 'donorBroadcast.v1';
  const FILTER_SOURCE_KEY = 'donorPaidSource.v1';
  const channel = (() => {
    try { return new BroadcastChannel('donors'); }
    catch (err) {
      console.warn('[DonorAdmin] BroadcastChannel unavailable:', err);
      return null;
    }
  })();
  const makeMessageId = (() => {
    let counter = 0;
    return () => `${Date.now().toString(36)}:${(counter++ % 1e6).toString(36)}`;
  })();
  function broadcast(msg) {
    const payload = { ...msg, _id: msg && msg._id ? msg._id : makeMessageId() };
    if (channel) {
      try { channel.postMessage(payload); }
      catch (err) { console.error('[DonorAdmin] Broadcast send failed:', err); }
    }
    try {
      localStorage.setItem(MSG_KEY, JSON.stringify(payload));
    } catch (err) {
      console.error('[DonorAdmin] Storage broadcast failed:', err);
    }
  }

  const $ = sel => document.querySelector(sel);
  const chipsEl = $('#chips');
  const modal = (() => {
    const overlay = document.getElementById('modalOverlay');
    const titleEl = overlay?.querySelector('.modal-title');
    const bodyEl = overlay?.querySelector('.modal-body');
    const actionsEl = overlay?.querySelector('.modal-actions');
    const closeBtn = overlay?.querySelector('.modal-close');
    if (!overlay || !titleEl || !bodyEl || !actionsEl || !closeBtn) {
      return {
        alert(message) { window.alert(message); return Promise.resolve(true); },
        confirm(message) { return Promise.resolve(window.confirm(message)); },
        dialog(opts = {}) {
          const msg = typeof opts.message === 'string' ? opts.message : '';
          const res = window.confirm(msg || '');
          return Promise.resolve(res ? (opts.okValue ?? true) : (opts.cancelValue ?? false));
        },
      };
    }

    let resolver = null;
    let dismissValue = null;
    let lastFocused = null;

    function close(value) {
      if (!overlay.classList.contains('open')) return;
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      document.removeEventListener('keydown', handleKeydown);
      if (lastFocused && typeof lastFocused.focus === 'function') {
        lastFocused.focus();
      }
      lastFocused = null;
      const resolve = resolver;
      resolver = null;
      if (resolve) resolve(value);
    }

    function handleKeydown(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        close(dismissValue);
      }
    }

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) close(dismissValue);
    });
    closeBtn.addEventListener('click', () => close(dismissValue));

    function setBodyContent(message) {
      bodyEl.innerHTML = '';
      if (typeof message === 'string') {
        bodyEl.textContent = message;
        return;
      }
      if (message && typeof message === 'object') {
        if (typeof message.html === 'string') {
          bodyEl.innerHTML = message.html;
          return;
        }
        if (typeof Node !== 'undefined' && message.node instanceof Node) {
          bodyEl.appendChild(message.node);
          return;
        }
      }
      bodyEl.textContent = '';
    }

    function show({ title = 'Notice', message = '', buttons = [], dismiss = false }) {
      return new Promise((resolve) => {
        resolver = resolve;
        dismissValue = dismiss;
        lastFocused = document.activeElement;
        titleEl.textContent = title;
        setBodyContent(message);
        actionsEl.innerHTML = '';
        let focusSet = false;
        buttons.forEach((btn, idx) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'modal-btn' + (btn.variant === 'primary' ? ' primary' : '');
          b.textContent = btn.label;
          if (btn.disabled) b.disabled = true;
          b.addEventListener('click', () => close(btn.value));
          actionsEl.appendChild(b);
          if (!focusSet && (btn.autoFocus || btn.variant === 'primary' || idx === 0)) {
            setTimeout(() => b.focus(), 0);
            focusSet = true;
          }
        });
        overlay.classList.add('open');
        overlay.removeAttribute('aria-hidden');
        document.addEventListener('keydown', handleKeydown);
      });
    }

    return {
      alert(message, opts = {}) {
        return show({
          title: opts.title || 'Notice',
          message,
          buttons: [{ label: opts.okText || 'OK', value: true, variant: 'primary' }],
          dismiss: true,
        });
      },
      confirm(message, opts = {}) {
        return show({
          title: opts.title || 'Confirm',
          message,
          buttons: [
            { label: opts.cancelText || 'Cancel', value: false },
            { label: opts.okText || 'Confirm', value: true, variant: 'primary' },
          ],
          dismiss: false,
        });
      },
      dialog(options) {
        return show(options || {});
      },
    };
  })();

  const normalizeName = s => s.normalize('NFKC').replace(/\s+/g,' ').trim();
  const keyName = s => normalizeName(s).toLowerCase();
  const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const save = list => localStorage.setItem(KEY, JSON.stringify(list));
  const loadEmph = () => {
    try {
      const raw = JSON.parse(localStorage.getItem(EMPH_KEY) || '[]');
      return new Set(Array.isArray(raw) ? raw : []);
    } catch {
      return new Set();
    }
  };
  const saveEmph = (set) => localStorage.setItem(EMPH_KEY, JSON.stringify(Array.from(set)));
  let emphCache = loadEmph();
  const broadcastEmphasisState = () => broadcast({ type:'emphasisSync', keys: Array.from(emphCache) });

  function persistEmphasis(){
    saveEmph(emphCache);
    broadcastEmphasisState();
  }

  function toggleEmphasize(name){
    const k = keyName(name);
    if (emphCache.has(k)) emphCache.delete(k); else emphCache.add(k);
    persistEmphasis();
    broadcast({ type:'emphasize', name });
    renderChips();
  }
  function deleteName(name) {
    const k = keyName(name);
    const list = load().filter(d => keyName(d.name) !== k);
    save(list);
    if (emphCache.delete(k)) persistEmphasis();
    broadcast({ type:'remove', key: k });
    renderChips();
  }

  function makeChip(d, emphSet){
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.name = d.name;
    chip.title = new Date(d.addedAt).toLocaleString();

    const label = document.createElement('span');
    label.className = 'label'; label.textContent = d.name;
    chip.appendChild(label);

    const isEmph = emphSet.has(keyName(d.name));
    if (isEmph) chip.classList.add('emph');
    if (isEmph) { const b = document.createElement('div'); b.className = 'badge'; b.textContent = '★'; chip.appendChild(b); }

    const handle = document.createElement('button');
    handle.className = 'handle'; handle.type = 'button'; handle.setAttribute('aria-label', 'Open actions'); handle.innerHTML = '&#8942;';
    chip.appendChild(handle);

    const menu = document.createElement('div'); menu.className = 'menu';
    const emph = document.createElement('button');
    emph.className = 'action-btn'; emph.type = 'button'; emph.setAttribute('data-act','emph'); emph.title = isEmph ? 'Un‑emphasize' : 'Emphasize';
    emph.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M12 3l2.4 4.86 5.37.78-3.88 3.78.92 5.36L12 15.9 7.19 17.78l.92-5.36L4.23 8.64l5.37-.78L12 3z"/></svg>';
    const del = document.createElement('button');
    del.className = 'action-btn'; del.type = 'button'; del.setAttribute('data-act','del'); del.title = 'Delete';
    del.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M3 6h18M9 6V4h6v2M8 6l1 14h6l1-14"/></svg>';
    menu.appendChild(emph); menu.appendChild(del); chip.appendChild(menu);

    return chip;
  }

  function renderChips() {
    const list = load();
    document.getElementById('count').textContent = list.length;
    const frag = document.createDocumentFragment();
    const emphSnapshot = new Set(emphCache);
    list.sort((a,b) => a.name.localeCompare(b.name, undefined, {sensitivity:'base'}))
        .forEach(d => frag.appendChild(makeChip(d, emphSnapshot)));
    chipsEl.innerHTML = ''; chipsEl.appendChild(frag);
  }

  function splitDonorText(raw) { return raw.split(new RegExp('[,\t\r\n]+','g')); }

  function addFromInput() {
    const raw = document.getElementById('nameInput').value;
    const tokens = splitDonorText(raw).map(s => s.trim()).filter(Boolean);
    if (!tokens.length) return;

    const list = load();
    const emphSet = new Set(emphCache);
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];

    for (const token of tokens) {
      const hasPlus = token.includes('+');
      const cleaned = token.replace(/\+/g, ' ');
      const nm = normalizeName(cleaned);
      const k = keyName(nm);
      if (!nm) continue;
      if (!existing.has(k)) {
        existing.add(k);
        const rec = { name: nm, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(rec);
        newOnes.push(rec);
      }
      if (hasPlus) emphSet.add(k);
    }

    if (newOnes.length) {
      localStorage.setItem(KEY, JSON.stringify(list));
      emphCache = emphSet;
      persistEmphasis();
      broadcast({ type:'added', donors: newOnes });
      for (const rec of newOnes) {
        const k = keyName(rec.name);
        if (emphSet.has(k)) broadcast({ type:'emphasize', name: rec.name });
      }
      renderChips();
    }

    document.getElementById('nameInput').value = '';
    document.getElementById('nameInput').focus();
  }

  async function clearAll() {
    const confirmed = await modal.confirm('Clear all donors? This will immediately update the display.');
    if (!confirmed) return;
    localStorage.setItem(KEY, '[]');
    emphCache.clear();
    persistEmphasis();
    broadcast({ type:'reset' });
    broadcast({ type:'clearEmph' });
    renderChips();
  }

  // CSV IMPORT
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('csvInput');
  const browseBtn = document.getElementById('browseBtn');
  const thresholdEl = document.getElementById('threshold');
  const filterSourceInput = document.getElementById('filterSource');
  const totalInput = document.getElementById('totalDisplay');
  const primaryStatusEl = document.getElementById('primaryStatus');
  const filterStatusEl = document.getElementById('filterStatus');
  let primaryRows = null;
  let filterRows = null;
  let primaryFileName = '';
  let filterFileName = '';
  const loadFilterSource = () => localStorage.getItem(FILTER_SOURCE_KEY) || '';
  let filterSource = loadFilterSource();
  const persistFilterSource = (val) => {
    filterSource = String(val || '').trim();
    localStorage.setItem(FILTER_SOURCE_KEY, filterSource);
  };
  const loadTotal = () => localStorage.getItem(TOTAL_KEY) || '';
  let totalLabel = loadTotal();
  const persistTotal = (val) => {
    totalLabel = String(val || '');
    localStorage.setItem(TOTAL_KEY, totalLabel);
    broadcast({ type:'totalUpdate', total: totalLabel });
  };
  if (filterSourceInput) {
    filterSourceInput.value = filterSource;
    filterSourceInput.addEventListener('change', (e) => {
      persistFilterSource(e.target.value.trim());
      updateCsvStatus();
    });
  }
  if (totalInput) {
    totalInput.value = totalLabel;
    totalInput.addEventListener('input', (e) => {
      persistTotal(e.target.value);
    });
  }
  broadcast({ type:'totalUpdate', total: totalLabel });

  function detectCsvKind(fileName = '', rows){
    const name = String(fileName || '').toLowerCase();
    if (name.includes('paid')) return 'filter';
    if (name.includes('onecause') && name.includes('donation')) return 'primary';
    const header = Array.isArray(rows?.[0]) ? rows[0] : null;
    if (header && header.some && header.some(col => /anonymous/i.test(String(col || '')))) return 'filter';
    if (header && header.some && header.some(col => /recognition/i.test(String(col || '')))) return 'primary';
    return 'primary';
  }

  function updateCsvStatus(){
    if (primaryStatusEl) {
      primaryStatusEl.textContent = primaryRows ? (primaryFileName || 'Loaded') : 'Not loaded';
      primaryStatusEl.classList.toggle('loaded', Boolean(primaryRows));
    }
    if (filterStatusEl) {
      const label = filterRows ? (filterFileName || 'Loaded') : 'Not loaded';
      const srcNote = filterSource ? ` (source: ${filterSource})` : '';
      filterStatusEl.textContent = label + srcNote;
      filterStatusEl.classList.toggle('loaded', Boolean(filterRows));
    }
  }

  const stripHeader = (rows) => {
    if (!Array.isArray(rows) || !rows.length) return [];
    return rows.filter((row, idx) => idx > 0 && Array.isArray(row) && row.some(cell => String(cell ?? '').trim() !== ''));
  };

  function parseCsvFile(file){
    Papa.parse(file, {
      complete: (res) => {
        const rawRows = Array.isArray(res.data) ? res.data : [];
        const rows = stripHeader(rawRows);
        const kind = detectCsvKind(file.name, rawRows);
        if (kind === 'filter') {
          filterRows = rows;
          filterFileName = file.name;
          console.log('[CSV] filter rows parsed:', rows.length);
        } else {
          primaryRows = rows;
          primaryFileName = file.name;
          console.log('[CSV] primary rows parsed:', rows.length);
        }
        fileInput.value = '';
        updateCsvStatus();
        if (primaryRows && kind === 'primary') {
          showCsvPreviewModal();
        } else if (primaryRows && kind === 'filter') {
          showCsvPreviewModal();
        } else if (!primaryRows && kind === 'filter') {
          modal.alert('Filter CSV loaded. Please load the OneCause - Donations CSV to preview.');
        }
      },
      skipEmptyLines: 'greedy'
    });
  }

  function handleFiles(files){
    const list = Array.from(files || []).filter(Boolean);
    if (!list.length) return;
    list.forEach(parseCsvFile);
  }
  browseBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); });
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); }));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); }));
  dropzone.addEventListener('drop', (e) => { handleFiles(e.dataTransfer.files); });

  const normalizeSource = (value) => String(value || '').trim().toLowerCase();
  const isYes = (value) => /^(yes|y|true|1)$/i.test(String(value || '').trim());

  function makeDonationKey(_time, first, last){
    const fn = keyName(first || '');
    const ln = keyName(last || '');
    if (!fn && !ln) return null;
    return `${ln || '_'}::${fn || '_'}`;
  }

  function extractPrimaryRecord(row){
    const recognitionRaw = row[12];
    const name = normalizeName(String(recognitionRaw || ''));
    if (!name) return null;
    if (/recognition/i.test(String(recognitionRaw || '')) && !row[4]) return null;
    const amountRaw = row[1];
    const amount = typeof amountRaw === 'number' ? amountRaw : parseFloat(String(amountRaw || '').replace(/[^0-9.-]/g,''));
    const donationTime = String(row[4] || '').trim();
    const lastName = String(row[9] || '');
    const firstName = String(row[10] || '');
    const donationSource = String(row[1] || '');
    const key = makeDonationKey(donationTime, firstName, lastName);
    return {
      name,
      amount: isFinite(amount) ? amount : 0,
      donationTime,
      donationSource,
      firstName,
      lastName,
      donationKey: key,
    };
  }

  function buildAnonKeySet(primaryRowsRef, filterRowsRef){
    if (!filterRowsRef || !filterRowsRef.length) return new Set();
    const normalizedSource = normalizeSource(filterSource);
    const blocked = new Set();
    (filterRowsRef || []).forEach(row => {
      const anonValue = row[17];
      if (!isYes(anonValue)) return;
      const src = normalizeSource(row[6]);
      if (normalizedSource && src !== normalizedSource) return;
      const key = makeDonationKey(row[1], row[8], row[9]);
      if (key) blocked.add(key);
    });
    return blocked;
  }

  const escapeHtml = (value = '') => String(value ?? '').replace(/[&<>"']/g, (ch) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',
  }[ch]));

  function summarizePrimary(rows, blockedSet, opts = {}){
    const threshold = Number(thresholdEl.value) || 0;
    const list = load();
    const existing = new Set(list.map(d => keyName(d.name)));
    const sample = [];
    const seenPreview = new Set();
    let considered = 0;
    let potentialAdds = 0;
    let emphasizeHits = 0;
    let filteredOut = 0;

    for (let i=0; i<rows.length; i++){
      const rec = extractPrimaryRecord(rows[i]);
      if (!rec) continue;
      considered++;
      if (blockedSet && blockedSet.has(rec.donationKey)) {
        filteredOut++;
        continue;
      }
      const k = keyName(rec.name);
      const shouldEmphasize = rec.amount >= threshold;
      if (shouldEmphasize) emphasizeHits++;
      if (!existing.has(k)){
        potentialAdds++;
        if (sample.length < 10 && !seenPreview.has(k)){
          sample.push({ name: rec.name, emphasize: shouldEmphasize });
          seenPreview.add(k);
        }
      }
    }

    return {
      considered,
      potentialAdds,
      emphasizeHits,
      sample,
      threshold,
      filteredOut,
      filterActive: Boolean(opts.filterCsvLoaded),
      filterSourceLabel: filterSource || '',
      filterCsvLoaded: Boolean(opts.filterCsvLoaded),
    };
  }

  function buildPreviewHtml(summary){
    if (!summary.considered) {
      return '<p>No usable rows were found in this CSV.</p>';
    }
    const items = summary.sample.map(item => `<li>${escapeHtml(item.name)}${item.emphasize ? ' <span class="preview-star">★</span>' : ''}</li>`).join('');
    const remainder = Math.max(0, summary.potentialAdds - summary.sample.length);
    const listHtml = summary.sample.length
      ? `<ol class="csv-preview-list">${items}</ol>${remainder ? `<p class="preview-note">…and ${remainder} more new name${remainder === 1 ? '' : 's'}.</p>` : ''}`
      : '<p class="preview-note">No brand-new donors detected.</p>';
    return [
      `<p class="preview-meta">Rows scanned: <strong>${summary.considered}</strong></p>`,
      `<p class="preview-meta">Potential new donors: <strong>${summary.potentialAdds}</strong></p>`,
      `<p class="preview-meta">Will emphasize (≥ $${summary.threshold}): <strong>${summary.emphasizeHits}</strong></p>`,
      summary.filterCsvLoaded
        ? `<p class="preview-meta">Anonymous filter (${escapeHtml(summary.filterSourceLabel || 'match OneCause source')}): <strong>${summary.filteredOut}</strong> removed</p>`
        : '<p class="preview-note">Optional paid-donations CSV not loaded, so anonymous donors will remain visible.</p>',
      listHtml,
    ].join('');
  }

  async function showCsvPreviewModal(){
    if (!primaryRows || !primaryRows.length) {
      modal.alert('No CSV data loaded yet.');
      return;
    }
    const blocked = buildAnonKeySet(primaryRows, filterRows);
    const summary = summarizePrimary(primaryRows, blocked, { filterCsvLoaded: Boolean(filterRows && filterRows.length) });
    const html = buildPreviewHtml(summary);
    const buttons = [
      { label: 'Cancel', value: 'cancel' },
      { label: 'Import All Rows', value: 'import', variant: 'primary', autoFocus: true, disabled: !summary.considered },
    ];
    const result = await modal.dialog({
      title: 'CSV Preview',
      message: { html },
      buttons,
      dismiss: 'cancel',
    });
    if (result === 'import') {
      importRows(primaryRows);
    }
  }

  function importRows(rows){
    if (!rows || !rows.length){ modal.alert('No CSV loaded yet.'); return; }
    const threshold = Number(thresholdEl.value) || 0;
    const blocked = buildAnonKeySet(primaryRows, filterRows);

    const list = load();
    const emphSet = new Set(emphCache);
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];
    let considered = 0, added = 0, emphasized = 0, filteredOut = 0;

    for (let i=0; i<rows.length; i++){
      const rec = extractPrimaryRecord(rows[i]);
      if (!rec) continue;
      considered++;
      if (blocked.has(rec.donationKey)) { filteredOut++; continue; }
      const k = keyName(rec.name);
      if (!existing.has(k)){
        existing.add(k);
        const d = { name: rec.name, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(d); newOnes.push(d); added++;
      }
      if (rec.amount >= threshold) { emphSet.add(k); emphasized++; }
    }

    if (newOnes.length){
      localStorage.setItem(KEY, JSON.stringify(list));
      emphCache = emphSet;
      persistEmphasis();
      broadcast({ type:'added', donors: newOnes });
      for (const d of newOnes) {
        const k = keyName(d.name);
        if (emphSet.has(k)) broadcast({ type:'emphasize', name: d.name });
      }
      renderChips();
    }
    const filterMsg = blocked.size ? `, Filtered anonymous: ${filteredOut}` : '';
    modal.alert('Import complete. Considered: '+considered+', Added: '+added+', Emphasized (>= $'+threshold+'): '+emphasized+filterMsg);
  }

  // Chip event delegation
  chipsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    const chip = e.target.closest('.chip');
    if (!chip) return;
    if (btn && btn.classList.contains('handle')) {
      document.querySelectorAll('.chip.menu-open').forEach(el => { if (el !== chip) el.classList.remove('menu-open'); });
      chip.classList.toggle('menu-open');
      return;
    }
    if (btn && btn.classList.contains('action-btn')) {
      const act = btn.getAttribute('data-act');
      const name = chip.dataset.name;
      if (act === 'emph') toggleEmphasize(name);
      if (act === 'del') deleteName(name);
      chip.classList.remove('menu-open');
      return;
    }
  });
  document.addEventListener('click', (e) => { if (!e.target.closest('.chip')) document.querySelectorAll('.chip.menu-open').forEach(el => el.classList.remove('menu-open')); });

  // THEME: read defaults from CSS, allow edit, push to display
  const gcs = getComputedStyle(document.documentElement);
  const defaults = {
    bg: gcs.getPropertyValue('--bg').trim() || '#f7f7f7',
    titleColor: gcs.getPropertyValue('--title-color').trim() || '#0f0f0f',
    nameColor: gcs.getPropertyValue('--name-color').trim() || '#0f0f0f',
    nameWeight: Number(gcs.getPropertyValue('--name-weight').trim() || '500'),
    emphColor: gcs.getPropertyValue('--emph-color').trim() || '#0f0f0f',
    emphWeight: Number(gcs.getPropertyValue('--emph-weight').trim() || '800'),
    emphScale: parseFloat(gcs.getPropertyValue('--emph-scale')) || 1.35,
    totalColor: gcs.getPropertyValue('--total-color').trim() || '#0f0f0f',
    totalWeight: Number(gcs.getPropertyValue('--total-weight').trim() || '500'),
  };
  function loadTheme(){ try { return JSON.parse(localStorage.getItem(THEME_KEY) || 'null'); } catch { return null; } }
  function saveTheme(theme){ localStorage.setItem(THEME_KEY, JSON.stringify(theme)); }

  function initThemeUI(){
    const bg = document.getElementById('bgColor');
    const tcol = document.getElementById('titleColor');
    const ncol = document.getElementById('nameColor');
    const ecol = document.getElementById('emphColor');
    const nwt = document.getElementById('nameWeight');
    const ewt = document.getElementById('emphWeight');
    const esc = document.getElementById('emphScale');
    const bgi = document.getElementById('bgImage');
    const totCol = document.getElementById('totalColor');
    const totW = document.getElementById('totalWeight');

    const saved = loadTheme() || defaults;
    const toHex = (v)=> {
      if (!v) return '#000000';
      const value = String(v).trim();
      if (!value) return '#000000';
      if (/^#/i.test(value)) return value;
      const parts = value.match(/\d+/g);
      if (!parts || !parts.length) return '#000000';
      return '#'+Array.from(parts.slice(0,3)).map(n=>('0'+Math.max(0, Math.min(255, Number(n)||0)).toString(16)).slice(-2)).join('');
    };

    bg.value = toHex(saved.bg);
    tcol.value = toHex(saved.titleColor);
    ncol.value = toHex(saved.nameColor);
    ecol.value = toHex(saved.emphColor);
    totCol.value = toHex(saved.totalColor);
    nwt.value = String(saved.nameWeight);
    ewt.value = String(saved.emphWeight);
    esc.value = String(saved.emphScale);
    totW.value = String(saved.totalWeight || defaults.totalWeight);

    document.getElementById('pushTheme').addEventListener('click', async () => {
      const theme = {
        bg: bg.value,
        titleColor: tcol.value,
        nameColor: ncol.value,
        nameWeight: Number(nwt.value),
        emphColor: ecol.value,
        emphWeight: Number(ewt.value),
        emphScale: parseFloat(esc.value),
        totalColor: totCol.value,
        totalWeight: Number(totW.value),
      };
      if (bgi.files && bgi.files[0]) {
        const dataUrl = await new Promise(res => { const fr = new FileReader(); fr.onload = e => res(e.target.result); fr.readAsDataURL(bgi.files[0]); });
        theme.bgImageData = dataUrl;
      } else {
        const cur = loadTheme(); if (cur && cur.bgImageData) theme.bgImageData = cur.bgImageData;
      }
      saveTheme(theme);
      broadcast({ type: 'themeUpdate', theme });
      modal.alert('Theme pushed to display.');
    });

    document.getElementById('resetTheme').addEventListener('click', () => {
      localStorage.removeItem(THEME_KEY);
      broadcast({ type: 'themeUpdate', theme: defaults });
      modal.alert('Theme reset to defaults and pushed.');
      bg.value = toHex(defaults.bg); tcol.value = toHex(defaults.titleColor);
      ncol.value = toHex(defaults.nameColor); ecol.value = toHex(defaults.emphColor);
      totCol.value = toHex(defaults.totalColor);
      nwt.value = String(defaults.nameWeight); ewt.value = String(defaults.emphWeight); esc.value = String(defaults.emphScale);
      totW.value = String(defaults.totalWeight);
      bgi.value='';
    });

    // push once on load so the display syncs even if opened later
    broadcast({ type: 'themeUpdate', theme: saved });
  }
  initThemeUI();

  // Basics
  document.getElementById('addNames').addEventListener('click', addFromInput);
  document.getElementById('clearAll').addEventListener('click', clearAll);
  document.getElementById('openDisplay').addEventListener('click', () => window.open('display.html', 'DonorDisplay', 'noopener,noreferrer'));
  document.getElementById('nameInput').addEventListener('keydown', (e) => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') addFromInput(); });
  window.addEventListener('storage', (e) => {
    if (e.key === EMPH_KEY) {
      emphCache = loadEmph();
    }
    if (e.key === TOTAL_KEY) {
      totalLabel = loadTotal();
      if (totalInput) totalInput.value = totalLabel;
    }
    if (e.key === KEY || e.key === EMPH_KEY) renderChips();
  });

  updateCsvStatus();
  renderChips();
})();
</script>
</body>
</html>
