<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Donor Board – Admin</title>
<link rel="icon" href="assets/favicon.svg">
<style>
  :root { --accent:#222; }
  body { font-family: system-ui, sans-serif; margin: 24px; color:#111; }
  h1 { margin: 0 0 12px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  textarea { width: min(900px, 100%); height: 180px; padding:12px; font-size:16px; }
  button { padding:10px 14px; border:1px solid #ccc; background:#fff; border-radius:10px; cursor:pointer; }
  button.primary { background:#111; color:#fff; border-color:#111; }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:6px 6px 0 0; font-size:14px; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>
  <h1>Donor Board – Admin</h1>

  <div class="row">
    <button id="openDisplay">Open Display Page</button>
    <button id="clearAll" title="Remove all donors (affects display)">Clear All</button>
    <span class="muted">Paste names (newline, comma, or tab-separated). Duplicates are ignored (case-insensitive, trimmed).</span>
  </div>

  <p></p>
  <textarea id="nameInput" placeholder="e.g.
Jane Smith	John D. Brown, Alicia Cruz
The Morales Family"></textarea>
  <p class="row">
    <button class="primary" id="addNames">Add Names</button>
  </p>

  <h3>Current donors (<span id="count">0</span>)</h3>
  <div id="chips"></div>

<script>
(() => {
  const KEY = 'donorList.v1';
  const CH = new BroadcastChannel('donors');
  const $ = sel => document.querySelector(sel);

  const normalizeName = s => s.normalize('NFKC').replace(/\s+/g,' ').trim();
  const keyName = s => normalizeName(s).toLowerCase();
  const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const save = list => localStorage.setItem(KEY, JSON.stringify(list));

  function renderChips() {
    const list = load();
    $('#count').textContent = list.length;
    $('#chips').innerHTML = list
      .sort((a,b) => a.name.localeCompare(b.name, undefined, {sensitivity:'base'}))
      .map(d => `<span class="pill" title="${new Date(d.addedAt).toLocaleString()}">${d.name}</span>`).join('');
  }

  function addFromInput() {
    const raw = $('#nameInput').value;
    // Split on newline OR comma OR tab
    const parts = raw.split(/[\n,\t]/g).map(normalizeName).filter(Boolean);
    if (!parts.length) return;

    const list = load();
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];

    for (const nm of parts) {
      const k = keyName(nm);
      if (!existing.has(k)) {
        existing.add(k);
        const rec = { name: nm, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(rec);
        newOnes.push(rec);
      }
    }

    if (newOnes.length) {
      save(list);
      CH.postMessage({ type:'added', donors: newOnes });
      renderChips();
    }

    $('#nameInput').value = '';
    $('#nameInput').focus();
  }

  function clearAll() {
    if (!confirm('Clear all donors? This will immediately update the display.')) return;
    save([]);
    CH.postMessage({ type:'reset' });
    renderChips();
  }

  $('#addNames').addEventListener('click', addFromInput);
  $('#clearAll').addEventListener('click', clearAll);
  $('#openDisplay').addEventListener('click', () => window.open('display.html', 'DonorDisplay', 'noopener,noreferrer'));
  $('#nameInput').addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') addFromInput();
  });

  window.addEventListener('storage', (e) => {
    if (e.key === KEY) renderChips();
  });

  renderChips();
})();
</script>
</body>
</html>