<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Donor Board – Admin</title>
<link rel="icon" href="assets/favicon.svg">
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="page" style="padding:24px; font-family: system-ui, sans-serif;">
    <h1 style="margin:0 0 12px;">Donor Board – Admin</h1>

    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button id="openDisplay">Open Display Page</button>
      <button id="clearAll" title="Remove all donors (affects display)">Clear All</button>
      <span style="color:#666; font-size:13px;">Paste names (newline, comma, or tab-separated). Add '+' anywhere in a name to auto‑emphasize it. Duplicates are ignored.</span>
    </div>

    <p></p>
    <textarea id="nameInput" style="width:min(900px,100%); height:180px; padding:12px; font-size:16px;" placeholder="e.g.
Jane Smith\tJohn D. Brown+, Alicia +Cruz
The +Morales Family"></textarea>
    <p class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button class="primary" id="addNames">Add Names</button>
    </p>

    <div class="admin-chips">
      <h3>Current donors (<span id="count">0</span>)</h3>
      <div id="chips"></div>
    </div>

    <!-- THEME PANEL (ADMIN) -->
    <div class="theme-panel" id="themePanel">
      <h3>Display Theme (push to display)</h3>
      <div class="theme-grid">
        <div class="theme-row"><label>Background</label><input type="color" id="bgColor"></div>
        <div class="theme-row"><label>Title color</label><input type="color" id="titleColor"></div>
        <div class="theme-row"><label>Name color</label><input type="color" id="nameColor"></div>
        <div class="theme-row"><label>Emphasized color</label><input type="color" id="emphColor"></div>
        <div class="theme-row"><label>Name weight</label>
          <select id="nameWeight">
            <option>300</option><option selected>500</option><option>600</option><option>700</option><option>800</option>
          </select>
        </div>
        <div class="theme-row"><label>Emph. weight</label>
          <select id="emphWeight">
            <option>600</option><option selected>800</option><option>900</option>
          </select>
        </div>
        <div class="theme-row"><label>Emph. scale</label><input type="range" id="emphScale" min="1.0" max="1.8" step="0.05" value="1.35"></div>
        <div class="theme-row"><label>Background image</label><input type="file" id="bgImage" accept="image/*"></div>
      </div>
      <div class="theme-actions">
        <button id="resetTheme">Reset</button>
        <button id="pushTheme">Apply & Push</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const KEY = 'donorList.v1';
  const EMPH_KEY = 'donorEmphasized.v1';
  const THEME_KEY = 'donorTheme.v1';
  const CH = new BroadcastChannel('donors');

  const $ = sel => document.querySelector(sel);
  const normalizeName = s => s.normalize('NFKC').replace(/\s+/g,' ').trim();
  const keyName = s => normalizeName(s).toLowerCase();
  const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const save = list => localStorage.setItem(KEY, JSON.stringify(list));
  const loadEmph = () => new Set(JSON.parse(localStorage.getItem(EMPH_KEY) || '[]'));
  const saveEmph = (set) => localStorage.setItem(EMPH_KEY, JSON.stringify(Array.from(set)));

  function toggleEmphasize(name){
    const k = keyName(name);
    const set = loadEmph();
    if (set.has(k)) set.delete(k); else set.add(k);
    saveEmph(set);
    CH.postMessage({ type:'emphasize', name });
    renderChips();
  }
  function deleteName(name) {
    const k = keyName(name);
    const list = load().filter(d => keyName(d.name) !== k);
    save(list);
    const set = loadEmph(); if (set.delete(k)) saveEmph(set);
    CH.postMessage({ type:'remove', key: k });
    renderChips();
  }

  function makeChip(d){
    const chip = document.createElement('div');
    const emphSet = loadEmph();
    const isEmph = emphSet.has(keyName(d.name));
    chip.className = 'chip' + (isEmph ? ' emph' : '');
    chip.dataset.name = d.name;
    chip.title = new Date(d.addedAt).toLocaleString();
    const label = document.createElement('span'); label.className = 'label'; label.textContent = d.name;
    chip.appendChild(label);
    if (isEmph) { const b = document.createElement('div'); b.className = 'badge'; b.textContent = '★'; chip.appendChild(b); }

    const menu = document.createElement('div'); menu.className = 'menu';
    const emph = document.createElement('button');
    emph.className = 'action-btn'; emph.setAttribute('data-act','emph'); emph.title = isEmph ? 'Un‑emphasize' : 'Emphasize';
    emph.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M12 3l2.4 4.86 5.37.78-3.88 3.78.92 5.36L12 15.9 7.19 17.78l.92-5.36L4.23 8.64l5.37-.78L12 3z"/></svg>';
    const del = document.createElement('button');
    del.className = 'action-btn'; del.setAttribute('data-act','del'); del.title = 'Delete';
    del.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M3 6h18M9 6V4h6v2M8 6l1 14h6l1-14"/></svg>';
    menu.appendChild(emph); menu.appendChild(del); chip.appendChild(menu);
    return chip;
  }

  function renderChips() {
    const list = load();
    document.getElementById('count').textContent = list.length;
    const frag = document.createDocumentFragment();
    list.sort((a,b) => a.name.localeCompare(b.name, undefined, {sensitivity:'base'})).forEach(d => frag.appendChild(makeChip(d)));
    document.getElementById('chips').innerHTML = ''; document.getElementById('chips').appendChild(frag);
  }

  function splitDonorText(raw) { return raw.split(new RegExp('[,\t\r\n]+','g')); }

  function addFromInput() {
    const raw = document.getElementById('nameInput').value;
    const tokens = splitDonorText(raw).map(s => s.trim()).filter(Boolean);
    if (!tokens.length) return;

    const list = load();
    const emphSet = loadEmph();
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];

    for (const token of tokens) {
      const hasPlus = token.includes('+');
      const cleaned = token.replace(/\+/g, ' ');
      const nm = normalizeName(cleaned);
      const k = keyName(nm);
      if (!nm) continue;
      if (!existing.has(k)) {
        existing.add(k);
        const rec = { name: nm, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(rec);
        newOnes.push(rec);
      }
      if (hasPlus) emphSet.add(k);
    }

    if (newOnes.length) {
      save(list);
      saveEmph(emphSet);
      CH.postMessage({ type:'added', donors: newOnes });
      for (const rec of newOnes) {
        const k = keyName(rec.name);
        if (emphSet.has(k)) CH.postMessage({ type:'emphasize', name: rec.name });
      }
      renderChips();
    }

    document.getElementById('nameInput').value = '';
    document.getElementById('nameInput').focus();
  }

  function clearAll() {
    if (!confirm('Clear all donors? This will immediately update the display.')) return;
    localStorage.setItem(KEY, '[]');
    localStorage.setItem(EMPH_KEY, '[]');
    CH.postMessage({ type:'reset' });
    CH.postMessage({ type:'clearEmph' });
    renderChips();
  }

  // ---------- THEME (Admin pushes to Display) ----------
  const gcs = getComputedStyle(document.documentElement);
  const defaults = {
    bg: gcs.getPropertyValue('--bg').trim() || '#f7f7f7',
    titleColor: gcs.getPropertyValue('--title-color').trim() || '#0f0f0f',
    nameColor: gcs.getPropertyValue('--name-color').trim() || '#0f0f0f',
    nameWeight: gcs.getPropertyValue('--name-weight').trim() || '500',
    emphColor: gcs.getPropertyValue('--emph-color').trim() || '#0f0f0f',
    emphWeight: gcs.getPropertyValue('--emph-weight').trim() || '800',
    emphScale: parseFloat(gcs.getPropertyValue('--emph-scale')) || 1.35,
  };
  function loadTheme(){ try { return JSON.parse(localStorage.getItem(THEME_KEY) || 'null'); } catch { return null; } }
  function saveTheme(theme){ localStorage.setItem(THEME_KEY, JSON.stringify(theme)); }

  function initThemeUI(){
    const bg = document.getElementById('bgColor');
    const tcol = document.getElementById('titleColor');
    const ncol = document.getElementById('nameColor');
    const ecol = document.getElementById('emphColor');
    const nwt = document.getElementById('nameWeight');
    const ewt = document.getElementById('emphWeight');
    const esc = document.getElementById('emphScale');
    const bgi = document.getElementById('bgImage');

    const saved = loadTheme() || defaults;
    const toHex = (v)=> /^#/.test(v)?v.trim():('#'+Array.from((v.match(/\d+/g)||[]).slice(0,3)).map(n=>('0'+(+n).toString(16)).slice(-2)).join(''));

    bg.value = toHex(saved.bg);
    tcol.value = toHex(saved.titleColor);
    ncol.value = toHex(saved.nameColor);
    ecol.value = toHex(saved.emphColor);
    nwt.value = String(saved.nameWeight);
    ewt.value = String(saved.emphWeight);
    esc.value = String(saved.emphScale);

    document.getElementById('pushTheme').addEventListener('click', async () => {
      const theme = {
        bg: bg.value,
        titleColor: tcol.value,
        nameColor: ncol.value,
        nameWeight: Number(nwt.value),
        emphColor: ecol.value,
        emphWeight: Number(ewt.value),
        emphScale: parseFloat(esc.value),
      };
      if (bgi.files && bgi.files[0]) {
        const dataUrl = await new Promise(res => { const fr = new FileReader(); fr.onload = e => res(e.target.result); fr.readAsDataURL(bgi.files[0]); });
        theme.bgImageData = dataUrl;
      } else {
        const cur = loadTheme(); if (cur && cur.bgImageData) theme.bgImageData = cur.bgImageData;
      }
      saveTheme(theme);
      // Push to display
      CH.postMessage({ type: 'themeUpdate', theme });
      alert('Theme pushed to display.');
    });

    document.getElementById('resetTheme').addEventListener('click', () => {
      localStorage.removeItem(THEME_KEY);
      CH.postMessage({ type: 'themeUpdate', theme: defaults });
      alert('Theme reset to defaults and pushed.');
      // Reset inputs
      bg.value = toHex(defaults.bg); tcol.value = toHex(defaults.titleColor);
      ncol.value = toHex(defaults.nameColor); ecol.value = toHex(defaults.emphColor);
      nwt.value = String(defaults.nameWeight); ewt.value = String(defaults.emphWeight); esc.value = String(defaults.emphScale);
      bgi.value='';
    });

    // On load, push current saved theme once so display can sync quickly if opened later
    if (saved) CH.postMessage({ type: 'themeUpdate', theme: saved });
  }

  // ---------- Wire events ----------
  document.getElementById('addNames').addEventListener('click', addFromInput);
  document.getElementById('clearAll').addEventListener('click', clearAll);
  document.getElementById('openDisplay').addEventListener('click', () => window.open('display.html', 'DonorDisplay', 'noopener,noreferrer'));
  document.getElementById('nameInput').addEventListener('keydown', (e) => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') addFromInput(); });
  window.addEventListener('storage', (e) => { if (e.key === KEY || e.key === EMPH_KEY) renderChips(); });

  renderChips();
  initThemeUI();
})();
</script>
</body>
</html>
