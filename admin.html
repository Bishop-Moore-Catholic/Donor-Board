<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Donor Board – Admin</title>
<link rel="icon" href="assets/favicon.svg">
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="page" style="padding:24px; font-family: system-ui, sans-serif;">
    <h1 style="margin:0 0 12px;">Donor Board – Admin</h1>

    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button id="openDisplay" type="button">Open Display Page</button>
      <button id="clearAll" type="button" title="Remove all donors (affects display)">Clear All</button>
      <span style="color:#666; font-size:13px;">Paste names (newline, comma, or tab‑separated). Add '+' anywhere in a name to auto‑emphasize it. Duplicates are ignored.</span>
    </div>

    <p></p>
    <textarea id="nameInput" style="width:min(900px,100%); height:180px; padding:12px; font-size:16px;" placeholder="e.g.
Jane Smith\tJohn D. Brown+, Alicia +Cruz
The +Morales Family"></textarea>
    <p class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button class="primary" id="addNames" type="button">Add Names</button>
    </p>

    <!-- CSV IMPORT -->
    <div class="import-wrap">
      <label class="dropzone" id="dropzone">
        <input type="file" id="csvInput" accept=".csv,text/csv" />
        <div>
          <strong>Drop a OneCause CSV here</strong><br/>
          <span class="hint">We’ll import <code>Column M</code> (names) and auto‑emphasize anyone with <code>Column B ≥ threshold</code>.</span><br/>
          <button type="button" id="browseBtn" style="margin-top:8px;">Browse…</button>
        </div>
      </label>
      <div class="controls">
        <div class="field"><label for="threshold"><strong>Emphasize threshold ($)</strong></label> <input type="number" id="threshold" min="0" step="50" value="1000"></div>
        <div class="field"><span>Columns used:</span> <code>B (amount)</code> & <code>M (name)</code></div>
        <div class="field"><button id="importPreview" type="button">Preview first 10</button> <button id="importAll" class="primary" type="button">Import all rows</button></div>
      </div>
    </div>

    <div class="admin-chips" style="margin-top:16px;">
      <h3>Current donors (<span id="count">0</span>)</h3>
      <div id="chips"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = 'donorList.v1';
  const EMPH_KEY = 'donorEmphasized.v1';
  const CH = new BroadcastChannel('donors');

  const $ = sel => document.querySelector(sel);
  const chipsEl = $('#chips');

  const normalizeName = s => s.normalize('NFKC').replace(/\s+/g,' ').trim();
  const keyName = s => normalizeName(s).toLowerCase();
  const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
  const save = list => localStorage.setItem(KEY, JSON.stringify(list));
  const loadEmph = () => new Set(JSON.parse(localStorage.getItem(EMPH_KEY) || '[]'));
  const saveEmph = (set) => localStorage.setItem(EMPH_KEY, JSON.stringify(Array.from(set)));

  function toggleEmphasize(name){
    const k = keyName(name);
    const set = loadEmph();
    if (set.has(k)) set.delete(k); else set.add(k);
    saveEmph(set);
    CH.postMessage({ type:'emphasize', name });
    renderChips();
  }
  function deleteName(name) {
    const k = keyName(name);
    const list = load().filter(d => keyName(d.name) !== k);
    save(list);
    const set = loadEmph(); if (set.delete(k)) saveEmph(set);
    CH.postMessage({ type:'remove', key: k });
    renderChips();
  }

  function makeChip(d){
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.name = d.name;
    chip.title = new Date(d.addedAt).toLocaleString();

    const label = document.createElement('span');
    label.className = 'label'; label.textContent = d.name;
    chip.appendChild(label);

    const emphSet = loadEmph();
    const isEmph = emphSet.has(keyName(d.name));
    if (isEmph) chip.classList.add('emph');
    if (isEmph) { const b = document.createElement('div'); b.className = 'badge'; b.textContent = '★'; chip.appendChild(b); }

    const handle = document.createElement('button');
    handle.className = 'handle'; handle.type = 'button'; handle.setAttribute('aria-label', 'Open actions'); handle.innerHTML = '&#8942;';
    chip.appendChild(handle);

    const menu = document.createElement('div'); menu.className = 'menu';
    const emph = document.createElement('button');
    emph.className = 'action-btn'; emph.type = 'button'; emph.setAttribute('data-act','emph'); emph.title = isEmph ? 'Un‑emphasize' : 'Emphasize';
    emph.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M12 3l2.4 4.86 5.37.78-3.88 3.78.92 5.36L12 15.9 7.19 17.78l.92-5.36L4.23 8.64l5.37-.78L12 3z"/></svg>';
    const del = document.createElement('button');
    del.className = 'action-btn'; del.type = 'button'; del.setAttribute('data-act','del'); del.title = 'Delete';
    del.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"><path d="M3 6h18M9 6V4h6v2M8 6l1 14h6l1-14"/></svg>';
    menu.appendChild(emph); menu.appendChild(del); chip.appendChild(menu);

    return chip;
  }

  function renderChips() {
    const list = load();
    document.getElementById('count').textContent = list.length;
    const frag = document.createDocumentFragment();
    list.sort((a,b) => a.name.localeCompare(b.name, undefined, {sensitivity:'base'}))
        .forEach(d => frag.appendChild(makeChip(d)));
    chipsEl.innerHTML = ''; chipsEl.appendChild(frag);
  }

  function splitDonorText(raw) { return raw.split(new RegExp('[,\t\r\n]+','g')); }

  function addFromInput() {
    const raw = document.getElementById('nameInput').value;
    const tokens = splitDonorText(raw).map(s => s.trim()).filter(Boolean);
    if (!tokens.length) return;

    const list = load();
    const emphSet = loadEmph();
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];

    for (const token of tokens) {
      const hasPlus = token.includes('+');
      const cleaned = token.replace(/\+/g, ' ');
      const nm = normalizeName(cleaned);
      const k = keyName(nm);
      if (!nm) continue;
      if (!existing.has(k)) {
        existing.add(k);
        const rec = { name: nm, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(rec);
        newOnes.push(rec);
      }
      if (hasPlus) emphSet.add(k);
    }

    if (newOnes.length) {
      save(list);
      saveEmph(emphSet);
      CH.postMessage({ type:'added', donors: newOnes });
      for (const rec of newOnes) {
        const k = keyName(rec.name);
        if (emphSet.has(k)) CH.postMessage({ type:'emphasize', name: rec.name });
      }
      renderChips();
    }

    document.getElementById('nameInput').value = '';
    document.getElementById('nameInput').focus();
  }

  function clearAll() {
    if (!confirm('Clear all donors? This will immediately update the display.')) return;
    localStorage.setItem(KEY, '[]');
    localStorage.setItem(EMPH_KEY, '[]');
    CH.postMessage({ type:'reset' });
    CH.postMessage({ type:'clearEmph' });
    renderChips();
  }

  // --- CSV IMPORT LOGIC ---
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('csvInput');
  const browseBtn = document.getElementById('browseBtn');
  const importPreview = document.getElementById('importPreview');
  const importAll = document.getElementById('importAll');
  const thresholdEl = document.getElementById('threshold');

  let parsedRows = null; // cached

  function handleFiles(files){
    const file = files && files[0];
    if (!file) return;
    Papa.parse(file, {
      complete: (res) => {
        parsedRows = Array.isArray(res.data) ? res.data : [];
        console.log('[CSV] parsed rows:', parsedRows.length);
        alert('CSV loaded: ' + parsedRows.length + ' rows.');
      },
      skipEmptyLines: 'greedy'
    });
  }

  browseBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
  }));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e) => {
    e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
  }));
  dropzone.addEventListener('drop', (e) => { handleFiles(e.dataTransfer.files); });

  function extractNameAmount(row){
    // Expected: amount in column B (index 1), name in column M (index 12).
    // Tolerate header row: if amount is non-numeric and name looks like a header, skip.
    if (!row) return null;
    const amountRaw = row[1];
    const nameRaw = row[12];
    const name = normalizeName(String(nameRaw || ''));
    const amt = typeof amountRaw === 'number' ? amountRaw :
                parseFloat(String(amountRaw || '').replace(/[^0-9.-]/g,''));
    if (!name) return null;
    if (!isFinite(amt) && /name|donor/i.test(String(nameRaw))) return null; // header guard
    return { name, amount: isFinite(amt) ? amt : 0 };
  }

  function importRows(rows, preview=false){
    if (!rows || !rows.length){ alert('No CSV loaded yet.'); return; }
    const threshold = Number(thresholdEl.value) || 0;

    const list = load();
    const emphSet = loadEmph();
    const existing = new Set(list.map(d => keyName(d.name)));
    const newOnes = [];
    let considered = 0, added = 0, emphasized = 0;

    for (let i=0; i<rows.length; i++){
      const rec = extractNameAmount(rows[i]);
      if (!rec) continue;
      considered++;
      const k = keyName(rec.name);
      if (!existing.has(k)){
        if (preview) {
          console.log('[Preview]', rec.name, 'amt:', rec.amount, 'emph:', rec.amount >= threshold);
          if (newOnes.length < 10) newOnes.push({ name: rec.name, addedAt: Date.now() });
          continue;
        }
        existing.add(k);
        const d = { name: rec.name, id: (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)), addedAt: Date.now() };
        list.push(d); newOnes.push(d); added++;
      }
      if (rec.amount >= threshold) { emphSet.add(k); emphasized++; }
    }

    if (preview){
      alert('Preview first 10 unique names logged to console. Considered rows: ' + considered);
      return;
    }

    if (newOnes.length){
      save(list);
      saveEmph(emphSet);
      CH.postMessage({ type:'added', donors: newOnes });
      for (const d of newOnes) {
        const k = keyName(d.name);
        if (emphSet.has(k)) CH.postMessage({ type:'emphasize', name: d.name });
      }
      renderChips();
    }
    alert('Import complete. Considered: '+considered+', Added: '+added+', Emphasized (>= $'+threshold+'): '+emphasized);
  }

  importPreview.addEventListener('click', () => importRows(parsedRows, true));
  importAll.addEventListener('click', () => importRows(parsedRows, false));

  // Event delegation for chips container (menu/handle)
  chipsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    const chip = e.target.closest('.chip');
    if (!chip) return;

    if (btn && btn.classList.contains('handle')) {
      document.querySelectorAll('.chip.menu-open').forEach(el => { if (el !== chip) el.classList.remove('menu-open'); });
      chip.classList.toggle('menu-open');
      return;
    }
    if (btn && btn.classList.contains('action-btn')) {
      const act = btn.getAttribute('data-act');
      const name = chip.dataset.name;
      if (act === 'emph') toggleEmphasize(name);
      if (act === 'del') deleteName(name);
      chip.classList.remove('menu-open');
      return;
    }
  });
  document.addEventListener('click', (e) => { if (!e.target.closest('.chip')) document.querySelectorAll('.chip.menu-open').forEach(el => el.classList.remove('menu-open')); });

  // Wire basics
  document.getElementById('addNames').addEventListener('click', addFromInput);
  document.getElementById('clearAll').addEventListener('click', clearAll);
  document.getElementById('openDisplay').addEventListener('click', () => window.open('display.html', 'DonorDisplay', 'noopener,noreferrer'));
  document.getElementById('nameInput').addEventListener('keydown', (e) => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') addFromInput(); });
  window.addEventListener('storage', (e) => { if (e.key === KEY || e.key === EMPH_KEY) renderChips(); });

  renderChips();
})();
</script>
</body>
</html>
